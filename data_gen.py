import os
import time
import random
import pickle
from tqdm import tqdm
from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor, as_completed, TimeoutError

curriculum = ["autophagy", "financial derivatives", "advanced programming", "modern teaching methods", "stoicism in modern life", "photosynthesis", "quantum mechanics", "universal basic income", "ai and society", "climate change", "gene editing", "socratic method", "theory of relativity", "sustainable development", "nanotechnology", "yoga practices", "democracy foundations", "existentialism", "classical literature", "world history", "comparative religion", "philosophy of mind", "political theory", "bioethics", "introduction to astronomy", "classical music", "language acquisition", "sociology of societies", "ecology principles", "medieval history", "ethnographic methods", "classical mechanics", "microeconomics", "linguistics", "archaeology", "genetics", "human and physical geography", "art history", "thermodynamics", "civil engineering", "financial markets", "public health", "particle physics", "world mythologies", "botany", "zoology", "material science", "theatre arts", "entrepreneurship", "classical languages", "moral philosophy", "cultural anthropology", "quantum physics", "veterinary science", "urban planning", "horticulture", "psychoanalysis", "metaphysics", "molecular biology", "oceanography", "forensic science", "nutrition science", "civil rights law", "information theory", "classical architecture", "epistemology", "constitutional law", "environmental science", "international relations", "optics", "mechanical engineering", "cognitive psychology", "classical mythology", "hydrology", "comparative literature", "evolutionary biology", "cybersecurity", "molecular genetics", "philosophy of science", "immunology", "developmental psychology", "electrical engineering", "operations research", "neuroscience", "aesthetics", "computational science", "paleontology", "urban sociology", "rhetoric", "cosmology", "behavioral economics", "quantum computing", "biophysics", "electromagnetism", "public administration", "solid state physics", "philosophy of law", "patristics", "aeronautical engineering", "political economy", "seismology", "bioinformatics", "renaissance literature", "philosophy of education", "structural engineering", "virology", "biochemical engineering", "islamic studies", "robotics", "medieval philosophy", "plasma physics", "environmental ethics", "quantitative social science", "roman law", "classical studies", "philosophy of religion", "wildlife conservation", "marine biology", "human geography", "ancient history", "peace studies", "african studies", "digital humanities", "east asian studies", "medicinal chemistry", "south asian studies", "latin american studies", "quantitative finance", "holocaust studies", "children's literature", "paleoanthropology", "classical philology", "homiletics", "comparative mythology", "embryology", "philosophy of art", "patent law", "gemology", "epigraphy", "hermeneutics", "comparative politics", "systematic theology", "paleography", "numerical analysis", "iconography", "talmudic studies", "diaspora studies", "hebrew bible studies", "classical rhetoric", "applied physics", "forensic anthropology", "health economics", "history of philosophy", "classical archaeology", "comparative linguistics", "criminology", "business ethics", "industrial organization", "gastroenterology", "biblical studies", "entomology", "public policy", "papyrology", "classical drama", "geophysics", "philosophy of mathematics", "latin literature", "ancient near eastern studies", "african american studies", "philosophy of history", "metallurgy", "ancient philosophy", "comparative education", "philosophy of technology", "gerontology", "rural sociology", "ancient greek literature", "experimental psychology", "kinesiology", "judicial studies", "economic history", "social psychology", "political sociology", "cultural studies", "food science", "agricultural technology", "atmospheric sciences", "urban ecology", "medical ethics", "bioinformatics", "quantum field theory", "cryptocurrency", "smart cities", "renewable energy sources", "paleoclimatology", "glaciology", "speech and language therapy", "neurolinguistics", "educational psychology", "space exploration", "game theory", "astronomical instrumentation", "volcanology", "mycology", "ornithology", "primatology", "sexuality studies", "aviation technology", "product design", "artificial intelligence ethics", "health informatics", "bioacoustics", "climate modeling", "ocean engineering", "textile engineering", "petroleum engineering", "remote sensing", "geographic information systems (GIS)", "biomechanics", "film studies", "music therapy", "urban economics", "disaster management", "public speaking", "persuasive writing", "creative writing", "translation studies", "audiology", "industrial design", "musicology", "data visualization", "blockchain technology", "virtual reality", "augmented reality", "human-computer interaction", "cyber-physical systems", "wireless communications", "network security", "space physics", "astrophysics", "cometary science", "high-energy particle astrophysics", "stellar astrophysics", "galactic astronomy", "extragalactic astronomy", "cosmochemistry", "interstellar medium studies", "observational astronomy", "theoretical astrophysics", "planetary geology", "space weather", "astrobiology", "exoplanet discovery", "dark matter research", "dark energy research", "cultural geography", "geopolitical studies", "urban anthropology", "public anthropology", "museum studies", "cultural heritage management", "indigenous studies", "gender studies", "disability studies", "addiction studies", "forensic psychology", "sports psychology", "positive psychology", "educational technology", "learning analytics", "mass communication", "journalism ethics", "film production", "theatre production", "music production", "sound engineering", "photography", "animation", "graphic design", "game design", "interior design", "fashion design", "landscape architecture", "information architecture", "user experience design", "accessibility studies", "sustainable agriculture", "agroecology", "soil science", "plant pathology", "weed science", "entomology", "agricultural economics", "hydroponic systems", "aquaponics", "precision agriculture", "agricultural policy", "food security", "food justice", "nutritional epidemiology", "metabolic biology", "personalized medicine", "pharmacogenomics", "stem cell research", "tissue engineering", "biomedical imaging", "rehabilitation science", "prosthetics and orthotics", "occupational therapy", "exercise science", "sport management", "public health nutrition", "global health", "epidemiology", "biostatistics", "health policy", "community health", "environmental health", "disease ecology", "wildlife disease management", "vector-borne diseases", "zoonotic diseases", "water resources management", "land reclamation", "environmental remediation", "natural resource management", "forestry", "sustainable fisheries", "wildlife conservation", "biodiversity conservation", "conservation genetics", "ecotourism", "environmental law", "environmental economics", "environmental psychology", "sustainability science", "green chemistry", "industrial ecology", "life cycle assessment", "carbon footprint analysis", "renewable resource management", "energy efficiency", "solar energy engineering", "wind energy engineering", "bioenergy", "geothermal energy", "hydropower", "nuclear engineering", "energy policy", "energy economics", "water treatment technology", "wastewater treatment", "solid waste management", "hazardous waste management", "recycling technology", "air pollution control", "noise pollution management", "indoor air quality", "climate change mitigation", "climate change adaptation", "climate policy", "urban planning and sustainability", "green building design", "smart grids", "electric vehicles", "transportation planning", "logistics and supply chain management", "operations management", "strategic management", "corporate social responsibility", "business analytics", "market research", "consumer behavior", "marketing strategy", "brand management", "sales management", "human resource management", "organizational behavior", "leadership studies", "negotiation and conflict resolution", "international business", "cross-cultural management", "entrepreneurial finance", "venture capital", "private equity", "corporate finance", "investment analysis", "financial risk management", "financial regulation", "behavioral finance", "real estate economics", "property law", "urban development", "real estate development", "digital marketing", "e-commerce", "social media marketing", "search engine optimization", "content marketing", "email marketing", "affiliate marketing", "mobile marketing", "viral marketing", "guerrilla marketing", "brand storytelling", "experiential marketing", "online reputation management", "public relations", "corporate communication", "crisis communication", "media planning", "advertising design", "copywriting", "broadcast journalism", "investigative journalism", "data journalism", "photojournalism", "documentary filmmaking", "radio production", "podcasting", "news writing", "editorial writing", "feature writing", "opinion writing", "speechwriting", "business writing", "technical writing", "science writing", "health and medical writing", "travel writing", "sports writing", "fashion writing", "food writing", "personal essay writing", "memoir writing", "biography writing", "autobiography writing", "narrative nonfiction writing", "literary nonfiction writing", "creative nonfiction writing", "fiction writing", "short story writing", "novel writing", "playwriting", "screenwriting", "comedy writing", "poetry writing", "children's book writing", "young adult book writing", "science fiction and fantasy writing", "historical fiction writing", "romance writing", "mystery and crime writing", "horror writing", "literary criticism", "book reviewing", "manuscript editing", "copy editing", "proofreading", "publishing law", "book marketing", "self-publishing", "academic publishing", "literary agency", "literary management", "writing workshops", "writing residencies", "readers' advisory", "library science", "information science", "archival science", "bibliometrics", "digitization", "information retrieval", "knowledge management", "preservation", "cataloging and classification", "reference services", "library management", "library programming", "library outreach", "academic libraries", "public libraries", "school libraries", "special libraries", "museum librarianship", "art librarianship", "music librarianship", "film and video librarianship", "health sciences librarianship", "law librarianship", "business librarianship", "map librarianship", "government documents librarianship", "digital libraries", "library technology", "library instruction", "information literacy", "bibliotherapy", "library spaces", "library marketing", "library advocacy", "library funding", "library legislation", "information ethics", "privacy and confidentiality", "data security", "information policy", "freedom of information", "intellectual freedom", "censorship", "copyright and copyright alternatives", "open access", "scholarly communication", "research data management", "scientific communication", "history of the book", "book arts", "bookbinding", "printing history", "typography", "book design", "illustration", "graphic novels", "comics studies", "zines", "artist's books", "ephemera", "manuscripts", "palaeography", "codicology", "incunabula", "rare books", "bibliophilia", "book collecting", "book trade", "publishing history", "bookselling", "book festivals", "book clubs", "reading groups", "literary societies", "writers' conferences", "literary festivals", "poetry readings", "storytelling festivals", "fan conventions", "book awards", "literary prizes", "writing competitions", "book reviews", "literary criticism", "biographies of authors", "literary memoirs", "writers' diaries and letters", "literary theory", "comparative literature", "world literature", "classical literature", "medieval literature", "renaissance literature", "enlightenment literature", "romantic literature", "victorian literature", "modernist literature", "postmodernist literature", "contemporary literature", "genre fiction", "literary fiction", "experimental fiction", "graphic literature", "poetry", "drama", "narrative nonfiction", "creative nonfiction", "memoir", "biography", "autobiography", "travel writing", "nature writing", "science writing", "sports writing", "food writing", "fashion writing", "popular culture writing", "film criticism", "music criticism", "art criticism", "theatre criticism", "literary translation", "linguistics", "semiotics", "rhetoric", "narratology", "poetics", "philosophy of literature", "psychoanalytic criticism", "marxist criticism", "feminist criticism", "queer theory", "postcolonial criticism", "cultural studies", "critical race theory", "disability studies", "ecocriticism", "reader-response criticism", "textual criticism", "bibliography", "manuscript studies", "book history", "print culture", "oral culture", "digital humanities", "book arts", "literary magazines", "literary journals", "poetry magazines", "literary presses", "independent publishers", "university presses", "small press publishing", "zine culture", "self-publishing", "e-book publishing", "audiobook publishing", "literary agents", "book marketing", "book distribution", "book publicity", "book design", "cover design", "illustration", "editing", "copyediting", "proofreading", "typesetting", "print production", "e-publishing", "digital distribution", "bookselling", "online bookselling", "independent bookstores", "chain bookstores", "used bookstores", "book fairs", "book auctions", "library sales", "book clubs", "reading groups", "book festivals", "writers' workshops", "writing retreats", "literary residencies", "writers' conferences", "literary competitions", "writing awards", "book awards", "literary prizes", "book reviews", "literary criticism", "literary memoirs", "author interviews", "literary podcasts", "book blogs", "literary YouTube channels", "bookstagram", "booktok", "literary Twitter", "literary Facebook groups", "online literary communities", "bookish merchandise", "literary-themed events", "book-themed travel", "literary landmarks", "author homes and museums", "literary trails", "bookish tourism", "library tourism", "bookmobiles", "book bikes", "pop-up libraries", "free little libraries", "library cafes", "book-themed cafes", "literary bars", "book and wine clubs", "book and beer clubs", "silent reading parties", "classic literature nights", "poetry slams", "storytelling events", "open mic nights", "literary salons", "reading marathons", "book swaps", "book drives", "reading challenges", "literary quizzes", "book-themed escape rooms", "library escape rooms", "library scavenger hunts", "literary geocaching", "book-themed board games", "book-themed video games", "literary trivia nights", "book club meetings", "book discussion groups", "literary lectures", "author talks", "book signings", "writing workshops", "creative writing courses", "poetry workshops", "screenwriting workshops", "playwriting workshops", "fiction writing courses", "nonfiction writing courses", "memoir writing workshops", "biography writing workshops", "autobiography writing workshops", "journal writing workshops", "travel writing workshops", "nature writing workshops", "science writing workshops", "abstract algebra", "algebraic geometry", "algebraic topology", "analysis of algorithms", "analytic geometry", "applied mathematics", "arithmetic", "astrophysics", "biostatistics", "boolean algebra", "calculus", "category theory", "chaos theory", "combinatorics", "complex analysis", "computational geometry", "computational mathematics", "differential equations", "differential geometry", "discrete mathematics", "dynamical systems", "econometrics", "elementary algebra", "elementary number theory", "financial mathematics", "finite mathematics", "fractal geometry", "functional analysis", "game theory", "geometric topology", "graph theory", "group theory", "harmonic analysis", "homological algebra", "informatics", "integral equations", "knot theory", "lie groups", "linear algebra", "logic", "mathematical biology", "mathematical economics", "mathematical finance", "mathematical logic", "mathematical modeling", "mathematical physics", "mathematical programming", "mathematical statistics", "matrix theory", "measure theory", "model theory", "nonlinear dynamics", "non-standard analysis", "number theory", "numerical linear algebra", "numerical methods", "operations analysis", "optimization", "ordinary differential equations", "partial differential equations", "probability", "probability theory", "pure mathematics", "quantitative analysis", "quantitative methods", "quantum algebra", "real analysis", "recreational mathematics", "regression analysis", "ring theory", "scientific computing", "set theory", "statistical mechanics", "statistics", "stochastic processes", "symplectic geometry", "theoretical computer science", "theoretical physics", "time series analysis", "topology", "trigonometry", "vector calculus", "wavelets", "zero-sum theory", "data science", "machine learning", "artificial intelligence", "cryptography", "network theory", "signal processing", "systems theory", "algorithm design", "software engineering", "object-oriented programming", "functional programming", "imperative programming", "reactive programming", "concurrent programming", "parallel programming", "distributed systems", "computer networks", "network security", "computer security", "cryptography", "database design", "relational databases", "NoSQL databases", "graph databases", "data structures", "data modeling", "data management", "big data analytics", "data science", "machine learning algorithms", "deep learning", "artificial neural networks", "natural language processing", "computer vision", "robotic process automation", "augmented reality development", "virtual reality development", "game development", "mobile application development", "web development", "front-end development", "back-end development", "full-stack development", "user interface design", "user experience design", "software testing methodologies", "automated testing", "manual testing", "performance testing", "security testing", "continuous integration/continuous deployment", "software deployment strategies", "version control systems", "software project management", "agile methodologies", "scrum framework", "kanban methodology", "lean software development", "devops practices", "microservices architecture", "software patterns and antipatterns", "domain-driven design", "system design", "cloud computing", "serverless architecture", "containerization technologies", "blockchain technology", "smart contract development", "Internet of Things (IoT) programming", "embedded systems design", "hardware programming", "open source software development", "software licensing", "ethical hacking", "cybersecurity best practices", "digital forensics", "penetration testing", "reinforcement learning", "supervised learning", "unsupervised learning", "time series analysis", "image processing", "signal processing", "computer graphics", "3D modeling and animation", "shader programming", "graphical user interface design", "accessibility in software design", "internationalization and localization", "performance optimization", "memory management", "concurrency models", "garbage collection algorithms", "compiler design", "interpreter design", "operational semantics", "formal verification", "formal methods in software engineering", "quantum computing fundamentals", "quantum algorithms", "quantum error correction", "cryptographic protocols", "syntax and semantics of programming languages", "type theory", "logic programming", "probabilistic programming", "bioinformatics algorithms", "computational geometry", "algorithmic game theory", "complexity theory", "computational complexity", "computability theory", "information theory", "coding theory", "distributed algorithms", "network protocols", "wireless networking", "mobile networking", "optical networks", "network management", "software-defined networking", "network function virtualization", "data privacy", "secure coding practices", "malware analysis", "cloud security", "application security", "operating system security", "blockchain security", "digital identity and access management", "cyber-physical systems security", "Internet censorship and surveillance", "ethical issues in AI and machine learning", "sustainable software engineering", "social implications of technology", "human-computer interaction", "augmented and mixed reality", "adaptive systems", "scalable computing", "fuzzy logic systems", "soft computing", "evolutionary computing", "genetic algorithms", "swarm intelligence", "neuro-fuzzy systems", "knowledge representation and reasoning", "semantic web technologies", "ontology engineering", "linked data and web of data", "information extraction", "information retrieval", "search engine optimization", "digital signal processing", "audio and speech processing", "biometric systems", "pattern recognition", "computational finance", "algorithmic trading", "quantitative finance", "high-frequency trading algorithms", "financial modeling and simulation", "computational advertising", "social network analysis", "graph mining", "text mining", "recommender systems", "computational biology", "molecular dynamics simulations", "genomics and genetics", "proteomics", "metabolomics", "systems biology", "computational neuroscience", "simulation and modeling", "high-performance computing", "parallel computing frameworks", "grid computing", "cloud services and APIs", "API design and development", "mobile sensing and context-aware computing", "wearable technology programming", "e-health applications development", "telemedicine software development", "digital humanities", "computational arts", "computational linguistics", "natural language understanding", "speech synthesis", "language generation", "dialogue systems", "language resources", "corpora building", "annotation tools", "language technology standards", "multimodal interaction", "gesture recognition", "eye tracking technologies", "brain-computer interface programming", "affective computing", "computational creativity", "game AI", "procedural content generation", "virtual characters and agents", "simulation of complex systems", "agent-based modeling", "cellular automata", "discrete event simulation", "multi-agent systems", "social simulation", "computational social science", "digital forensics tools and techniques", "incident response and management", "cyber threat intelligence", "cyber warfare and defense", "critical infrastructure protection", "privacy-enhancing technologies", "anonymity and pseudonymity", "secure multiparty computation", "homomorphic encryption", "post-quantum cryptography", "zero-knowledge proofs", "trusted computing", "digital rights management", "software preservation", "legacy system migration", "reverse engineering", "benchmarking and performance analysis", "data center management", "IT service management", "technology entrepreneurship", "innovation management", "technology transfer", "start-up ecosystems", "intellectual property management in IT", "IT law and policy", "computer history", "IT industry trends", "emerging technologies"]

# export OPENAI_API_KEY=sk-...
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# Constants
CONCURRENT_CALLS = 256
DATASET_PATH = "dialogs.pkl"
FETCH_TIMEOUT = 30
RETRY_ATTEMPTS = 10

def fetch_dialog_with_retry():
    for attempt in range(RETRY_ATTEMPTS):
        try:
            prompt = f"Write a socratic dialog, in which the user begins, between an assistant and his user about {random.choice(curriculum)}"
            response = client.chat.completions.create(model="gpt-3.5-turbo-0125",  messages=[{"role": "user", "content": prompt}], temperature=1.0, max_tokens=2048)
            return response.choices[0].message.content.strip()
        except Exception as e:
            print(f"Error fetching dialog (Attempt {attempt + 1}/{RETRY_ATTEMPTS}): {e}\nCooling down for {(attempt + 2) * 2} seconds before retrying...")
            time.sleep((attempt + 2) * 2)
    return None

def generate_dialogs(file_path):
    file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), file_path)
    responses = []
    
    with ThreadPoolExecutor() as executor:
        tasks = [executor.submit(fetch_dialog_with_retry) for _ in range(CONCURRENT_CALLS)]
        for task in tqdm(as_completed(tasks), total=CONCURRENT_CALLS, desc=f"Fetching dialogs"):
            response = None
            try:
                response = task.result(timeout=FETCH_TIMEOUT)
            except TimeoutError:
                print("Task exceeded the allowed time to complete.")
            if response:
                responses.append(response)


    updated_responses = []
    for response in responses:
        try:
            response = response.lower()

            if response.count("user: ") == 0 or response.count("\n\nuser: ") <= 1 or response.count("\n\nassistant: ") <= 1 or response.count("socratic dialog") >= 1:
                print(f"Ill-formed dialog. Skipping...")
                continue
            
            response = response.replace("\n\nuser: ", "\n[USER] ")
            response = response.replace("\n\nassistant: ", "\n[ASSISTANT] ")
            response = response.replace("user: ", "[USER] ")
            response = response.replace("\n", " ")
            updated_responses.append(response)
        except Exception as e:
            print(f"Error processing response: {e}\nSkipping...")
            continue

    if os.path.exists(file_path):
        with open(file_path, "rb") as file:
            existing_responses = pickle.load(file)
        updated_responses.extend(existing_responses)
    
    with open(file_path, "wb") as file:
        pickle.dump(updated_responses, file)

if __name__ == "__main__":
    while True:
        generate_dialogs(DATASET_PATH)
        print("Cooling down for 30 seconds...")
        time.sleep(30)